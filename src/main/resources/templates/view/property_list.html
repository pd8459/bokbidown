<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<div layout:fragment="content" class="position-relative" style="height: calc(100vh - 56px); width: 100%; overflow: hidden;">

    <div id="map" style="width: 100%; height: 100%; z-index: 1;"></div>

    <div id="sidebar" class="bg-white shadow-lg position-absolute top-0 start-0 h-100 d-flex flex-column"
         style="width: 400px; z-index: 2000; transform: translateX(-100%); transition: transform 0.3s ease-in-out;">

        <div class="p-3 border-bottom bg-light">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold m-0">단지 내 매물 목록</h5>
                <button type="button" class="btn-close" onclick="closeSidebar()"></button>
            </div>
            <p id="complexAddress" class="text-muted small m-0 text-truncate"></p>
        </div>

        <div id="propertyListContainer" class="flex-grow-1 overflow-auto p-0 bg-light">
        </div>
    </div>

    <script type="text/javascript" th:src="'//dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoMapKey}"></script>

    <script th:inline="javascript">
        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(37.54, 126.99),
            level: 7
        };

        var map = new kakao.maps.Map(container, options);

        var imageSrc = 'https://cdn-icons-png.flaticon.com/512/25/25694.png';
        var imageSize = new kakao.maps.Size(45, 45);
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

        /*<![CDATA[*/
        var rawPropertyList = [[${properties}]];
        /*]]>*/

        function formatMoney(money) {
            if (money >= 100000000) {
                var uk = Math.floor(money / 100000000);
                var rest = Math.floor((money % 100000000) / 10000);
                return uk + "억" + (rest > 0 ? " " + rest : "");
            } else {
                return Math.floor(money / 10000) + "만";
            }
        }

        var groupedProperties = {};

        rawPropertyList.forEach(function(data) {
            if (!data.latitude || !data.longitude) return;
            var key = data.latitude + "," + data.longitude;

            if (!groupedProperties[key]) {
                groupedProperties[key] = [];
            }
            groupedProperties[key].push(data);
        });

        function openSidebar(address, list) {
            var sidebar = document.getElementById('sidebar');
            var container = document.getElementById('propertyListContainer');
            var addressEl = document.getElementById('complexAddress');

            addressEl.innerText = address;
            container.innerHTML = '';

            list.forEach(function(item) {
                var typeBadge = (item.tradeType === 'JEONSE')
                    ? '<span class="badge bg-primary me-1">전세</span>'
                    : '<span class="badge bg-success me-1">매매</span>';

                var priceStr = formatMoney(item.deposit);
                var desc = item.description ? item.description : '설명 없음';

                var html = `
                    <div class="card border-0 border-bottom rounded-0 p-3 hover-bg">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>${typeBadge} <span class="fw-bold fs-5 text-primary">${priceStr}</span></div>
                        </div>
                        <div class="text-dark small mb-2 text-truncate">${desc}</div>
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="alert('상세보기 ID: ${item.id}')">
                            상세 정보 보기
                        </button>
                    </div>
                `;
                container.innerHTML += html;
            });

            sidebar.style.transform = 'translateX(0)';
        }

        function closeSidebar() {
            document.getElementById('sidebar').style.transform = 'translateX(-100%)';
        }

        for (var key in groupedProperties) {
            (function(k) {
                var list = groupedProperties[k];
                var firstItem = list[0];
                var lat = firstItem.latitude;
                var lng = firstItem.longitude;

                var marker = new kakao.maps.Marker({
                    map: map,
                    position: new kakao.maps.LatLng(lat, lng),
                    image: markerImage,
                    clickable: true
                });

                var content = `<div style="background:red; color:white; border-radius:50%; width:20px; height:20px; text-align:center; font-size:12px; line-height:20px; font-weight:bold; position:relative; top:-50px; left:10px; box-shadow:1px 1px 3px rgba(0,0,0,0.3);">
                                ${list.length}
                               </div>`;

                var customOverlay = new kakao.maps.CustomOverlay({
                    position: new kakao.maps.LatLng(lat, lng),
                    content: content
                });
                customOverlay.setMap(map);

                kakao.maps.event.addListener(marker, 'click', function() {
                    openSidebar(firstItem.address, list);
                });
            })(key);
        }
    </script>

    <style>
        .hover-bg:hover { background-color: #f8f9fa; cursor: pointer; }
    </style>
</div>
</html>